

<div class="example-header">
  <button mat-mini-fab color="primary" [routerLink]="['/new-mission']" matTooltip="Ajouter une mission">
    <mat-icon>add</mat-icon>
  </button>
  <mat-form-field>
      <mat-label>Chercher une mission</mat-label>
      <input matInput (keyup)="applyFilter($event)" placeholder="Chercher une mission, une ville, un secteur d'activité...">
    </mat-form-field>
    
  </div>

  <mat-slide-toggle (click)="showOnlyMyMissions()" *ngIf="userIsManagerInclude" [checked]="true">Afficher uniquement mes missions. </mat-slide-toggle>&nbsp;&nbsp;
<mat-slide-toggle (click)="showOnlyMyValidatedMissions()" *ngIf="userIsManagerInclude&&onlyMyMissionsChecked" [checked]="false">Cacher mes missions validées </mat-slide-toggle>
<br>
<br>

<div class="example-container mat-elevation-z8">
<mat-table #table [dataSource]="dataSource" matSort>

  <!--- Note that these columns can be defined in any order.
        The actual rendered columns are set as a property on the row definition" -->


        <ng-container matColumnDef="select">
          <mat-header-cell *matHeaderCellDef>
            <mat-checkbox (change)="$event ? masterToggle() : null"
                          [checked]="selection.hasValue() && isAllSelected()"
                          [indeterminate]="selection.hasValue() && !isAllSelected()"
                          [disabled] = "onlyMyMissionsChecked==false">
            </mat-checkbox>
          </mat-header-cell>

          <mat-header-cell *matCellDef="let row">
            <mat-checkbox (click)="$event.stopPropagation() || onClick($event,row)"
                          (change)="$event ? selection.toggle(row) : null"
                          [checked]="selection.isSelected(row)"
                          [disabled]="row.sheetStatus=='ON_WAITING'&&row.versions?.length==null&&row.lastVersion.versionDate==null">
            </mat-checkbox>
          </mat-header-cell>
        </ng-container>


  <!-- Position Column -->
  <ng-container matColumnDef="title">
    <mat-header-cell *matHeaderCellDef mat-sort-header> Titre de la mission </mat-header-cell>
    <mat-cell *matCellDef="let element"> {{element.lastVersion.title}} </mat-cell>
      </ng-container>
      
      <ng-container matColumnDef="consultant">
    <mat-header-cell *matHeaderCellDef mat-sort-header> Consultant </mat-header-cell>
    <mat-cell *matCellDef="let element"> {{element.consultant.firstname}} {{element.consultant.lastname}} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="customer">
    <mat-header-cell *matHeaderCellDef mat-sort-header> Client </mat-header-cell>
    <mat-cell *matCellDef="let element"> {{element.customer.name}} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="city">
    <mat-header-cell *matHeaderCellDef mat-sort-header> Ville </mat-header-cell>
    <mat-cell *matCellDef="let element"> {{element.lastVersion.city}} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="manager">
    <mat-header-cell *matHeaderCellDef mat-sort-header> Manager </mat-header-cell>
    <mat-cell *matCellDef="let element"> {{element.consultant.manager.firstname}} {{element.consultant.manager.lastname}}</mat-cell>
      </ng-container>

      <ng-container matColumnDef="numberOfProjects">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Nombre de projets </mat-header-cell>
        <mat-cell *matCellDef="let element">
          <i *ngIf= "element.lastVersion.projects?.length>0">{{element.lastVersion.projects?.length}}</i>
          <i *ngIf= "element.lastVersion.projects?.length==null">Aucun</i>          
        </mat-cell>
          </ng-container>

      <ng-container matColumnDef="sheetStatus">
          <mat-header-cell *matHeaderCellDef>Statut de la fiche</mat-header-cell>
          <mat-header-cell *matCellDef="let element" [ngSwitch]="element.sheetStatus">
              <span *ngSwitchCase="'ON_WAITING'" style="color: red" class="material-icons" matTooltip="Fiche en attente" >highlight_off</span>
              <span *ngSwitchCase="'ON_GOING'" style="color: orange" class="material-icons" matTooltip="Fiche en cours de validation">schedule</span>
              <span *ngSwitchCase="'VALIDATED'" style="color: green" class="material-icons" matTooltip="Fiche validée">done</span>
              &nbsp;
    
              <button mat-icon-button *ngIf="element.consultant.manager.id==this.user.id" [routerLink]="['/missions', element.id]">
                <span class="material-icons" matTooltip="Modifier la mission" >edit</span>
              </button>&nbsp;
              
    
              <button mat-icon-button  color="warn" *ngIf="(element.versions?.length==null&&element.lastVersion.versionDate==null&&element.consultant.manager.id==this.user.id&&element.sheetStatus=='ON_WAITING')">
                <span class="material-icons" matTooltip="Supprimer la mission en attente" (click)="openDeleteDialog(element)">delete</span>
              </button>
              
              
    
          </mat-header-cell>
      </ng-container>


  <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
  <mat-row *matRowDef="let row; columns: displayedColumns;" matRipple class="element-row" [cdkDetailRow]="row" [cdkDetailRowTpl]="tpl"  >
  </mat-row>
</mat-table>
<mat-paginator [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
</div>

<ng-template #tpl let-element>
<div class="mat-row detail-row" [@detailExpand] style="overflow: hidden">

<mat-table [dataSource]="element.lastVersion.projects" class="mat-elevation-z8">
  <ng-container matColumnDef="select">
      <mat-header-cell *matHeaderCellDef></mat-header-cell>
      <mat-header-cell *matCellDef="let row">
        <mat-checkbox (click)="$event.stopPropagation()|| onClick($event,row)"
                      (change)="$event ? selection.toggle(row) : null"
                      [checked]="selection.isSelected(row)"
                      [disabled]='!(row?.title.length>0)'>
        </mat-checkbox>
      </mat-header-cell>
    </ng-container>
<ng-container matColumnDef="project-name">
  <mat-header-cell *matHeaderCellDef> Titre du projet </mat-header-cell>
  <mat-cell *matCellDef="let element"> {{element.title}} </mat-cell>
</ng-container>

<ng-container matColumnDef="project-description">
  <mat-header-cell *matHeaderCellDef> Description du projet </mat-header-cell>
  <mat-cell *matCellDef="let element"> {{element.description}} </mat-cell>
</ng-container>

<mat-header-row *matHeaderRowDef="innerDisplayedColumns"></mat-header-row>
<mat-row *matRowDef="let row; columns: innerDisplayedColumns;" [class.example-element-row]="element?.lastVersion.projects.length" (click)="row?.title.length>0 ? selection.toggle(row) : null"></mat-row>
</mat-table>
</div>
</ng-template>
<br />

<p *ngIf="this.selection.selected.length>0">Éléments sélectionnés : {{this.selection.selected.length}}</p>






<!-- Copyright 2018 Google Inc. All Rights Reserved.
    Use of this source code is governed by an MIT-style license that
    can be found in the LICENSE file at http://angular.io/license -->    